# 页面分析工具使用指南

## 功能说明

页面分析工具 (`page-analyzer-tool.js`) 是一个强大的辅助工具，用于在 Amazon 页面更新后快速重新生成字段配置映射。它能够：

1. **自动扫描页面**：递归查找所有 Label 元素（包括 Shadow DOM 中的）
2. **智能匹配输入框**：为每个 Label 找到对应的输入框（input/textarea/select/kat-*）
3. **提取字段信息**：获取 UID、Name、ID、Placeholder 等属性
4. **生成 JSON 配置**：导出为兼容 `AMAZON_FIELDS` 格式的 JSON
5. **生成分析报告**：创建可读的文本报告

## 使用方法

### 方法1：控制台快捷命令

1. 打开 Amazon 商品编辑页面（例如：产品详情页、报价页等）
2. 打开浏览器开发者工具（F12）
3. 切换到 Console 标签
4. 输入以下命令：

```javascript
analyzeAmazonPage()
```

5. 工具会自动分析页面并在控制台输出结果

### 方法2：手动创建分析器

```javascript
const analyzer = new AmazonPageAnalyzer();
const mappings = analyzer.analyzePage();
```

## 导出结果

### 导出 JSON 配置

```javascript
const analyzer = analyzeAmazonPage();
analyzer.downloadJSON();  // 下载 JSON 文件
```

生成的 JSON 格式示例：

```json
{
  "商品名称": {
    "uid": "46_38",
    "type": "textbox",
    "fallback": {
      "labels": ["商品名称"],
      "name": "item_name"
    }
  },
  "品牌名": {
    "uid": "46_42",
    "type": "textbox",
    "fallback": {
      "labels": ["品牌名"],
      "name": "brand_name"
    }
  }
}
```

### 导出分析报告

```javascript
const analyzer = analyzeAmazonPage();
analyzer.downloadReport();  // 下载文本报告
```

报告示例：

```
========== Amazon 页面字段分析报告 ==========

分析时间: 2025-12-08 17:20:00
页面URL: https://sellercentral-japan.amazon.com/...
找到字段数: 45

========== 字段列表 ==========

字段: 商品名称
  Label: 商品名称
  类型: text (kat-input)
  UID: 46_38
  Name: item_name
  Shadow DOM: 是
```

## 工作原理

### 查找策略

工具使用多层级查找策略来定位输入框：

1. **for 属性**：检查 `<label for="xxx">` 关联
2. **内部查找**：查找 Label 内部的输入框
3. **Shadow DOM**：穿透 Shadow DOM 查找
4. **父级容器**：向上查找最多5层父级元素

### 输入框类型识别

- `<input>` / `<kat-input>` → textbox
- `<textarea>` / `<kat-textarea>` → textbox
- `<select>` / `<kat-select>` / `<kat-combobox>` → dropdown
- `<input type="radio">` → radio
- `<input type="checkbox">` → checkbox

## 应用场景

### 场景1：Amazon 页面更新后重新配置

当 Amazon 更新页面结构，导致原有的 UID 或选择器失效时：

1. 打开更新后的页面
2. 运行 `analyzeAmazonPage()`
3. 下载 JSON 配置
4. 将新的配置合并到 `amazon-form-filler.js` 的 `AMAZON_FIELDS` 中

### 场景2：添加新的表单页面支持

当需要支持新的 Amazon 表单页面时：

1. 导航到新页面
2. 运行分析工具
3. 获取该页面的所有字段配置
4. 添加到代码中

### 场景3：调试字段定位问题

当某个字段无法正确填写时：

1. 运行分析工具
2. 查看该字段的详细信息（UID、Name、选择器等）
3. 对比现有配置，找出差异
4. 更新配置

## 注意事项

1. **页面必须完全加载**：确保所有动态内容都已加载完成
2. **一次分析一个页面**：不同的 Tab（产品详情、报价等）需要分别分析
3. **手动验证**：自动生成的配置可能需要人工审核和调整
4. **Shadow DOM 支持**：工具已支持 Shadow DOM，但某些深层嵌套可能需要特殊处理

## 高级用法

### 查看原始映射数据

```javascript
const analyzer = analyzeAmazonPage();
console.log(analyzer.fieldMappings);
```

### 只导出特定字段

```javascript
const analyzer = new AmazonPageAnalyzer();
analyzer.analyzePage();

// 过滤只包含 "价格" 相关的字段
const priceFields = Object.entries(analyzer.fieldMappings)
    .filter(([key, value]) => key.includes('价格') || value.labelText.includes('价格'))
    .reduce((obj, [key, value]) => ({ ...obj, [key]: value }), {});

console.log(priceFields);
```

### 自定义字段键名生成规则

如果需要自定义字段键名的生成方式，可以修改 `generateFieldKey()` 方法。

## 与现有代码集成

生成的 JSON 可以直接复制到 `amazon-form-filler.js` 的 `AMAZON_FIELDS` 对象中：

```javascript
const AMAZON_FIELDS = {
    productDetails: {
        // 将分析工具生成的 JSON 粘贴到这里
        title: {
            uid: '46_38',
            type: 'textbox',
            fallback: {
                labels: ['商品名称'],
                name: 'item_name'
            }
        },
        // ... 更多字段
    }
};
```

## 故障排查

### 问题：找不到某些字段

**原因**：字段可能在折叠的区域或需要特定操作才显示

**解决**：
1. 展开所有折叠区域
2. 切换到"所有属性"视图
3. 重新运行分析

### 问题：Shadow DOM 中的字段未找到

**原因**：某些 Shadow DOM 可能有访问限制

**解决**：
1. 检查控制台是否有权限错误
2. 尝试手动检查元素结构
3. 使用浏览器的 Elements 面板查看 Shadow DOM

### 问题：生成的选择器不准确

**原因**：页面结构复杂或动态生成

**解决**：
1. 优先使用 UID（最稳定）
2. 其次使用 Name 或 ID
3. Label 文本作为最后的后备方案

## 总结

页面分析工具大大简化了维护 Amazon 表单字段配置的工作。当 Amazon 更新页面时，不再需要手动逐个查找元素，只需运行一次分析即可获得完整的字段映射。
