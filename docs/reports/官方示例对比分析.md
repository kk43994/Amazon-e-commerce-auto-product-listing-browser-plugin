# å®˜æ–¹ç¤ºä¾‹å¯¹æ¯”åˆ†æ

**åˆ†ææ—¥æœŸ**: 2025-11-12
**å®˜æ–¹æ–‡ä»¶**: ziniao_webdriver_http_py3.py

---

## ğŸ”¥ å…³é”®å‘ç°!

### å‘ç°1: å¯åŠ¨å‰å¿…é¡»å…ˆå…³é—­ç´«é¸Ÿæµè§ˆå™¨ä¸»è¿›ç¨‹! â­â­â­

**å®˜æ–¹ä»£ç ** (ç¬¬408è¡Œ):
```python
if __name__ == "__main__":
    """ éœ€è¦ä»ç³»ç»Ÿå³ä¸‹è§’è§’æ ‡å°†ç´«é¸Ÿæµè§ˆå™¨é€€å‡ºåå†è¿è¡Œ"""
```

**å®˜æ–¹ä»£ç ** (ç¬¬445-447è¡Œ):
```python
# ç»ˆæ­¢ç´«é¸Ÿå®¢æˆ·ç«¯å·²å¯åŠ¨çš„è¿›ç¨‹
kill_process(version="v5")  # æˆ– v6
```

**kill_processå‡½æ•°** (ç¬¬23-41è¡Œ):
```python
def kill_process(version: Literal["v5", "v6"]):
    # ç¡®è®¤æ˜¯å¦ç»§ç»­
    confirmation = input("åœ¨å¯åŠ¨ä¹‹å‰ï¼Œéœ€è¦å…ˆå…³é—­ç´«é¸Ÿæµè§ˆå™¨çš„ä¸»è¿›ç¨‹ï¼Œç¡®å®šè¦ç»ˆæ­¢è¿›ç¨‹å—ï¼Ÿ(y/n): ")
    if version == "v5":
        process_name = 'SuperBrowser.exe'
    else:
        process_name = 'ziniao.exe'
    if confirmation.lower() == 'y':
        if is_windows:
            os.system('taskkill /f /t /im ' + process_name)
```

âœ… **è¿™å°±æ˜¯é—®é¢˜æ‰€åœ¨!**

**æˆ‘ä»¬çš„é—®é¢˜**:
- ç´«é¸Ÿæµè§ˆå™¨å¯èƒ½å·²ç»åœ¨åå°è¿è¡Œ(GUIæ¨¡å¼)
- å¯åŠ¨WebDriveræ¨¡å¼æ—¶ä¸ç°æœ‰è¿›ç¨‹å†²çª
- å¯¼è‡´æ–°è¿›ç¨‹æ— æ³•æ­£å¸¸å¯åŠ¨HTTPæœåŠ¡å™¨

**è§£å†³æ–¹æ¡ˆ**:
1. å…ˆå…³é—­æ‰€æœ‰ç´«é¸Ÿæµè§ˆå™¨è¿›ç¨‹
2. å†å¯åŠ¨WebDriveræ¨¡å¼

---

### å‘ç°2: HTTPé€šä¿¡æ–¹å¼æœ‰ç»†å¾®å·®å¼‚

**å®˜æ–¹ä»£ç ** (ç¬¬92-104è¡Œ):
```python
def send_http(data):
    try:
        url = 'http://127.0.0.1:{}'.format(socket_port)
        response = requests.post(url, json.dumps(data).encode('utf-8'), timeout=120)
        return json.loads(response.text)
    except Exception as err:
        print(err)
```

**æˆ‘ä»¬çš„ä»£ç **:
```python
response = requests.post(url, json=data, timeout=120)
return response.json()
```

**å…³é”®å·®å¼‚**:
- å®˜æ–¹: `json.dumps(data).encode('utf-8')` - æ‰‹åŠ¨åºåˆ—åŒ–ä¸ºbytes
- æˆ‘ä»¬: `json=data` - requestsè‡ªåŠ¨å¤„ç†

âš ï¸ **å¯èƒ½çš„å½±å“**: ç¼–ç å¤„ç†æ–¹å¼ä¸åŒ,è™½ç„¶é€šå¸¸æ²¡é—®é¢˜,ä½†æœ€å¥½ä¸å®˜æ–¹ä¸€è‡´

---

### å‘ç°3: éœ€è¦å…ˆæ›´æ–°å†…æ ¸

**å®˜æ–¹æµç¨‹** (ç¬¬449-452è¡Œ):
```python
print("=====å¯åŠ¨å®¢æˆ·ç«¯=====")
start_browser()
print("=====æ›´æ–°å†…æ ¸=====")
update_core()  # é‡è¦!
```

**update_coreå‡½æ•°** (ç¬¬64-90è¡Œ):
```python
def update_core():
    """
    ä¸‹è½½æ‰€æœ‰å†…æ ¸ï¼Œæ‰“å¼€åº—é“ºå‰è°ƒç”¨ï¼Œéœ€å®¢æˆ·ç«¯ç‰ˆæœ¬5.285.7ä»¥ä¸Š
    å› ä¸ºhttpæœ‰è¶…æ—¶æ—¶é—´ï¼Œæ‰€ä»¥è¿™ä¸ªactioné€‚åˆå¾ªç¯è°ƒç”¨ï¼Œç›´åˆ°è¿”å›æˆåŠŸ
    """
    data = {
        "action": "updateCore",
        "requestId": str(uuid.uuid4()),
    }
    data.update(user_info)
    while True:
        result = send_http(data)
        if result.get("statusCode") == 0:
            print("æ›´æ–°å†…æ ¸å®Œæˆ")
            return
        else:
            print(f"ç­‰å¾…æ›´æ–°å†…æ ¸: {json.dumps(result)}")
            time.sleep(2)
```

âš ï¸ **æˆ‘ä»¬ç¼ºå°‘è¿™ä¸€æ­¥!**

è™½ç„¶ä¸æ˜¯å¿…é¡»çš„,ä½†å®˜æ–¹ç¤ºä¾‹éƒ½åŒ…å«äº†è¿™ä¸ªæ­¥éª¤ã€‚

---

### å‘ç°4: è¿”å›å­—æ®µåç¡®è®¤

**å®˜æ–¹ä»£ç ** (ç¬¬218è¡Œ):
```python
port = open_ret_json.get('debuggingPort')
```

âœ… **ç¡®è®¤**: å­—æ®µåæ˜¯ `debuggingPort`,æˆ‘ä»¬å·²ç»ä¿®å¤æ­£ç¡®!

---

### å‘ç°5: browserListè¿”å›æ ¼å¼ç¡®è®¤

**å®˜æ–¹ä»£ç ** (ç¬¬189-206è¡Œ):
```python
def get_browser_list() -> list:
    # ...
    r = send_http(data)
    if str(r.get("statusCode")) == "0":
        print(r)
        return r.get("browserList")  # ç›´æ¥å– browserList
```

âœ… **ç¡®è®¤**: è¿”å›æ ¼å¼æ˜¯ `browserList`,æˆ‘ä»¬å·²ç»ä¿®å¤æ­£ç¡®!

---

### å‘ç°6: è®¤è¯ä¿¡æ¯ä½¿ç”¨æ–¹å¼

**å®˜æ–¹å®šä¹‰** (ç¬¬426-430è¡Œ):
```python
user_info = {
    "company": "æ‚¨ç™»å…¥ç´«é¸Ÿæµè§ˆå™¨çš„æ—¶å€™è¾“å…¥çš„ä¼ä¸šå…¬å¸å",
    "username": "æ‚¨ç™»å…¥ç´«é¸Ÿæµè§ˆå™¨çš„æ—¶å€™è¾“å…¥çš„ä¼ä¸šç”¨æˆ·å",
    "password": "æ‚¨ç™»å…¥ç´«é¸Ÿæµè§ˆå™¨çš„æ—¶å€™è¾“å…¥çš„å¯†ç "
}
```

**å®˜æ–¹ä½¿ç”¨æ–¹å¼** (ç¬¬147, 176, 195è¡Œ):
```python
data.update(user_info)  # åœ¨æ¯ä¸ªAPIè°ƒç”¨ä¸­éƒ½æ·»åŠ è®¤è¯ä¿¡æ¯
```

âœ… **ç¡®è®¤**: æ‰€æœ‰APIéƒ½éœ€è¦è®¤è¯ä¿¡æ¯,æˆ‘ä»¬å·²ç»ä¿®å¤æ­£ç¡®!

---

## è¯¦ç»†å¯¹æ¯”è¡¨

| é¡¹ç›® | å®˜æ–¹å®ç° | æˆ‘ä»¬çš„å®ç° | çŠ¶æ€ |
|------|---------|-----------|------|
| å¯åŠ¨å‰å…³é—­è¿›ç¨‹ | âœ… kill_process() | âŒ ç¼ºå¤± | **éœ€è¦æ·»åŠ ** |
| HTTPè¯·æ±‚æ–¹å¼ | json.dumps().encode() | json=data | âš ï¸ å»ºè®®æ”¹ä¸ºå®˜æ–¹æ–¹å¼ |
| æ›´æ–°å†…æ ¸ | âœ… update_core() | âŒ ç¼ºå¤± | å»ºè®®æ·»åŠ  |
| debuggingPort | âœ… | âœ… | âœ… å·²ä¿®å¤ |
| browserList | âœ… | âœ… | âœ… å·²ä¿®å¤ |
| è®¤è¯ä¿¡æ¯ | âœ… data.update() | âœ… æ‰‹åŠ¨æ·»åŠ  | âœ… å·²ä¿®å¤ |
| å¯åŠ¨å‚æ•° | âœ… --run_typeç­‰ | âœ… | âœ… ä¸€è‡´ |

---

## å®˜æ–¹å®Œæ•´æµç¨‹

```python
# 1. å…³é—­ç°æœ‰è¿›ç¨‹
kill_process(version="v6")

# 2. å¯åŠ¨å®¢æˆ·ç«¯
start_browser()

# 3. æ›´æ–°å†…æ ¸
update_core()

# 4. è·å–åº—é“ºåˆ—è¡¨
browser_list = get_browser_list()

# 5. æ‰“å¼€åº—é“º
ret_json = open_store(store_id)

# 6. åˆ›å»ºWebDriver
driver = get_driver(ret_json)

# 7. æ‰§è¡Œè‡ªåŠ¨åŒ–æ“ä½œ
# ...

# 8. å…³é—­åº—é“º
close_store(store_id)

# 9. é€€å‡ºå®¢æˆ·ç«¯
get_exit()
```

---

## æˆ‘ä»¬ç¼ºå°‘çš„åŠŸèƒ½

### 1. kill_process() - å…³é—­ç°æœ‰è¿›ç¨‹ â­ é‡è¦!

**ä¼˜å…ˆçº§**: P0 (æœ€é«˜)

è¿™æ˜¯å¯¼è‡´å½“å‰é—®é¢˜çš„æœ€å¯èƒ½åŸå› !

---

### 2. update_core() - æ›´æ–°å†…æ ¸

**ä¼˜å…ˆçº§**: P1 (å»ºè®®)

è™½ç„¶ä¸æ˜¯å¿…é¡»,ä½†å®˜æ–¹æµç¨‹åŒ…å«æ­¤æ­¥éª¤ã€‚

---

### 3. get_exit() - ä¼˜é›…é€€å‡º

**ä¼˜å…ˆçº§**: P1 (å»ºè®®)

å®˜æ–¹ä»£ç æœ€åè°ƒç”¨ `get_exit()` å…³é—­å®¢æˆ·ç«¯ã€‚

---

## ç«‹å³ä¿®å¤æ–¹æ¡ˆ

### ä¿®å¤1: æ·»åŠ è¿›ç¨‹å…³é—­åŠŸèƒ½ â­â­â­

**åœ¨ ZiniaoManager ç±»ä¸­æ·»åŠ **:

```python
def kill_existing_process(self) -> bool:
    """
    å…³é—­å·²å­˜åœ¨çš„ç´«é¸Ÿæµè§ˆå™¨è¿›ç¨‹

    Returns:
        bool: æ˜¯å¦æˆåŠŸå…³é—­
    """
    import platform
    import os

    system = platform.system()

    if system == 'Windows':
        try:
            os.system('taskkill /f /t /im ziniao.exe')
            print("[INFO] å·²å…³é—­ç°æœ‰ç´«é¸Ÿæµè§ˆå™¨è¿›ç¨‹")
            time.sleep(2)  # ç­‰å¾…è¿›ç¨‹å®Œå…¨å…³é—­
            return True
        except Exception as e:
            print(f"[WARN] å…³é—­è¿›ç¨‹å¤±è´¥: {e}")
            return False
    elif system == 'Darwin':  # Mac
        try:
            os.system('killall ziniao')
            time.sleep(3)
            return True
        except Exception as e:
            print(f"[WARN] å…³é—­è¿›ç¨‹å¤±è´¥: {e}")
            return False
    else:
        print("[WARN] ä¸æ”¯æŒçš„æ“ä½œç³»ç»Ÿ")
        return False
```

**åœ¨ start_client() å¼€å§‹æ—¶è°ƒç”¨**:

```python
def start_client(self) -> bool:
    # å…ˆå…³é—­å·²å­˜åœ¨çš„è¿›ç¨‹
    print("[INFO] æ£€æŸ¥å¹¶å…³é—­ç°æœ‰è¿›ç¨‹...")
    self.kill_existing_process()

    # æ£€æŸ¥æ˜¯å¦å·²ç»åœ¨è¿è¡Œ
    if self._check_connection():
        # ...
```

---

### ä¿®å¤2: ä¿®æ”¹HTTPè¯·æ±‚æ–¹å¼

**ä¿®æ”¹æ‰€æœ‰APIè°ƒç”¨**:

```python
# ä¿®æ”¹å‰
response = requests.post(self.base_url, json=data, timeout=120)

# ä¿®æ”¹å (ä¸å®˜æ–¹ä¸€è‡´)
import json
response = requests.post(
    self.base_url,
    json.dumps(data).encode('utf-8'),
    timeout=120
)
```

---

### ä¿®å¤3: æ·»åŠ  update_core æ¥å£

```python
def update_core(self) -> bool:
    """
    æ›´æ–°æµè§ˆå™¨å†…æ ¸

    Returns:
        bool: æ›´æ–°æ˜¯å¦æˆåŠŸ
    """
    data = {
        "action": "updateCore",
        "requestId": str(uuid.uuid4()),
        "company": self.company,
        "username": self.username,
        "password": self.password
    }

    print("[INFO] å¼€å§‹æ›´æ–°å†…æ ¸...")

    while True:
        try:
            response = requests.post(self.base_url, json=data, timeout=120)
            result = response.json()

            if result.get('statusCode') == 0:
                print("[OK] å†…æ ¸æ›´æ–°å®Œæˆ")
                return True
            elif result.get('statusCode') == -10003:
                print("[WARN] å½“å‰ç‰ˆæœ¬ä¸æ”¯æŒæ­¤æ¥å£")
                return False
            else:
                print(f"[INFO] ç­‰å¾…å†…æ ¸æ›´æ–°...")
                time.sleep(2)

        except Exception as e:
            print(f"[ERROR] æ›´æ–°å†…æ ¸å¤±è´¥: {e}")
            time.sleep(2)
```

---

### ä¿®å¤4: æ·»åŠ  exit æ¥å£

```python
def exit_client(self) -> bool:
    """
    ä¼˜é›…é€€å‡ºç´«é¸Ÿæµè§ˆå™¨å®¢æˆ·ç«¯

    Returns:
        bool: æ˜¯å¦æˆåŠŸé€€å‡º
    """
    if not self.is_running:
        return True

    data = {
        "action": "exit",
        "requestId": str(uuid.uuid4()),
        "company": self.company,
        "username": self.username,
        "password": self.password
    }

    try:
        print("[INFO] æ­£åœ¨é€€å‡ºç´«é¸Ÿæµè§ˆå™¨...")
        response = requests.post(self.base_url, json=data, timeout=30)
        result = response.json()

        if result.get('statusCode') == 0:
            print("[OK] ç´«é¸Ÿæµè§ˆå™¨å·²é€€å‡º")
            self.is_running = False
            return True
        else:
            print(f"[WARN] é€€å‡ºå¤±è´¥: {result.get('err')}")
            return False

    except Exception as e:
        print(f"[ERROR] é€€å‡ºå¼‚å¸¸: {e}")
        return False
```

---

## æµ‹è¯•å»ºè®®

### ç«‹å³æµ‹è¯• - æ‰‹åŠ¨å…³é—­è¿›ç¨‹

**æœ€ç®€å•çš„éªŒè¯æ–¹æ³•**:

1. **å…³é—­æ‰€æœ‰ç´«é¸Ÿæµè§ˆå™¨è¿›ç¨‹**:
   ```bash
   taskkill /f /t /im ziniao.exe
   ```

2. **è¿è¡Œæµ‹è¯•è„šæœ¬**:
   ```bash
   python test_ziniao_connection.py
   ```

3. **é¢„æœŸç»“æœ**:
   - âœ… æ­¥éª¤1: å¯åŠ¨ç´«é¸Ÿæµè§ˆå™¨æˆåŠŸ
   - âœ… æ­¥éª¤2: æ£€æŸ¥HTTPè¿æ¥æˆåŠŸ (è¿™æ¬¡åº”è¯¥èƒ½è¿ä¸Š!)
   - âœ… æ­¥éª¤3: ç™»å½•æˆåŠŸ
   - âœ… æ­¥éª¤4: è·å–åº—é“ºåˆ—è¡¨æˆåŠŸ
   - âœ… æ­¥éª¤5: å¯åŠ¨åº—é“ºæµè§ˆå™¨æˆåŠŸ

---

## æ€»ç»“

### é—®é¢˜æ ¹æº ğŸ¯

**ç´«é¸Ÿæµè§ˆå™¨çš„GUIè¿›ç¨‹ä¸WebDriveræ¨¡å¼å†²çª!**

- å¦‚æœå·²ç»æœ‰ç´«é¸Ÿæµè§ˆå™¨åœ¨è¿è¡Œ(GUIæ¨¡å¼)
- å†å¯åŠ¨WebDriveræ¨¡å¼ä¼šå¤±è´¥
- å¿…é¡»å…ˆå…³é—­æ‰€æœ‰è¿›ç¨‹

### è§£å†³æ–¹æ¡ˆ âœ…

1. **ç«‹å³æµ‹è¯•** (ä¸ä¿®æ”¹ä»£ç ):
   ```bash
   taskkill /f /t /im ziniao.exe
   python test_ziniao_connection.py
   ```

2. **ä»£ç ä¿®å¤** (å»ºè®®):
   - æ·»åŠ  `kill_existing_process()` æ–¹æ³•
   - åœ¨ `start_client()` å¼€å§‹æ—¶è‡ªåŠ¨å…³é—­ç°æœ‰è¿›ç¨‹
   - æ·»åŠ  `update_core()` å’Œ `exit_client()` æ–¹æ³•

### ä»£ç è´¨é‡ âœ…

æˆ‘ä»¬çš„æ ¸å¿ƒå®ç°ä¸å®˜æ–¹ä¸€è‡´:
- âœ… APIè°ƒç”¨æ ¼å¼æ­£ç¡®
- âœ… è®¤è¯å‚æ•°å®Œæ•´
- âœ… å­—æ®µåç§°æ­£ç¡®
- âœ… è¿”å›æ ¼å¼æ­£ç¡®

å”¯ä¸€çš„é—®é¢˜æ˜¯ç¼ºå°‘è¿›ç¨‹ç®¡ç†åŠŸèƒ½ã€‚

---

**åˆ†æå®Œæˆæ—¶é—´**: 2025-11-12
**åˆ†æå¸ˆ**: Claude Code
**å…³é”®å‘ç°**: å¿…é¡»å…ˆå…³é—­ç°æœ‰ç´«é¸Ÿæµè§ˆå™¨è¿›ç¨‹!
